<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Messenger</title>

  <!-- CSP MUSS auf EINER Zeile sein -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com/firebasejs/ https://cdn.tailwindcss.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' blob: data: https://firebasestorage.googleapis.com; media-src 'self' blob: data: https://firebasestorage.googleapis.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://identitytoolkit.googleapis.com https://firestore.googleapis.com https://securetoken.googleapis.com wss://*.firebaseio.com; base-uri 'self'; form-action 'self';">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#1f2937">

  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .blinking-dot {
      width: 8px; height: 8px; background-color: #10b981;
      border-radius: 50%; display: inline-block;
      animation: blink 1s infinite;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .modal-box { transform: scale(0.9); opacity: 0; transition: all 0.2s; }
    .modal-box.active { transform: scale(1); opacity: 1; }
    #message-list { scroll-behavior: smooth; }
    .message-bubble { max-width: 70%; word-wrap: break-word; }
    @media (max-width: 640px) { .message-bubble { max-width: 85%; } }
  </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans antialiased">

  <noscript>
    <div class="p-4 bg-red-700 text-white text-center">
      JavaScript is required. Please enable it. / JavaScript ist erforderlich. Bitte aktivieren Sie es.
    </div>
  </noscript>

  <!-- Security Banner -->
  <div id="security-banner" class="hidden bg-emerald-900/40 border-b border-emerald-700 text-emerald-100 p-2 text-sm" role="alert">
    <span class="blinking-dot mr-2"></span>
    <strong>Info:</strong> <span id="banner-message">Security update available.</span>
    <button id="banner-close" class="float-right text-emerald-300 hover:text-emerald-100" aria-label="Close banner">‚úï</button>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 z-50 flex-col items-center justify-center bg-gray-900 bg-opacity-90 hidden" role="status" aria-live="polite">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    <p id="loading-text" class="mt-4 text-lg">Loading...</p>
  </div>

  <!-- Modal Dialog -->
  <div id="modal-overlay" class="fixed inset-0 z-40 hidden items-center justify-center bg-gray-900 bg-opacity-80" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div id="modal-box" class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md mx-4">
      <h2 id="modal-title" class="text-2xl font-bold mb-2 text-white"></h2>
      <p id="modal-text" class="text-gray-400 mb-4"></p>
      <input id="modal-input" type="text" class="hidden w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-gray-200 outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Input..." aria-label="Modal input field">
      <div id="modal-extra" class="text-sm text-gray-400 mb-4"></div>
      <div class="flex justify-end space-x-3">
        <button id="modal-cancel" class="px-4 py-2 rounded-md text-gray-300 hover:bg-gray-700 transition">Cancel</button>
        <button id="modal-ok" class="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white font-semibold transition">OK</button>
      </div>
    </div>
  </div>

  <!-- Auth View -->
  <div id="auth-view" class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md bg-gray-800 rounded-lg shadow-xl p-8">
      <h1 class="text-4xl font-bold text-white mb-2 text-center">üîí Secure Messenger</h1>
      <p class="text-gray-400 mb-6 text-center">End-to-end encrypted</p>
      
      <div class="space-y-4">
        <input id="username-input" type="text" placeholder="Choose username (3-20 characters)" class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-3 text-gray-200 outline-none focus:ring-2 focus:ring-blue-500" maxlength="20" aria-label="Username">
        <button id="register-button" class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition">Initialize Session</button>
        
        <div class="border-t border-gray-700 pt-4 mt-4">
          <p class="text-sm text-gray-400 mb-2">Or restore backup:</p>
          <button id="restore-button-auth" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition">Import Backup</button>
        </div>
      </div>
      
      <p class="text-xs text-gray-500 mt-6 text-center">
        Your keys are generated locally and never sent to the server.
      </p>
    </div>
  </div>

  <!-- App View -->
  <div id="app-view" class="hidden h-screen w-full flex flex-col sm:flex-row overflow-hidden">
    
    <!-- Sidebar -->
    <aside class="w-full sm:w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
      <!-- User Profile Header -->
      <div class="p-4 border-b border-gray-700 bg-gray-900">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-bold text-white">Profile</h2>
          <button id="logout-button" class="text-sm px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded transition" aria-label="Logout">Logout</button>
        </div>
        <p class="text-sm text-gray-400">
          <span id="current-username-display" class="font-semibold text-white">‚Äî</span>
        </p>
        <div class="flex items-center space-x-2 mt-2">
          <input id="user-id-display" type="text" readonly class="flex-1 text-xs bg-gray-800 border border-gray-700 rounded px-2 py-1 text-gray-400" aria-label="User ID">
          <button id="copy-id-button" class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded transition">Copy</button>
        </div>
      </div>

      <!-- Chat List -->
      <div class="flex-1 overflow-y-auto p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-md font-semibold text-gray-300">Chats</h3>
          <button id="add-chat-button" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition" aria-label="Add new chat">+ New</button>
        </div>
        <div id="chat-list" class="space-y-2"></div>
      </div>

      <!-- Settings Section -->
      <div class="p-4 border-t border-gray-700 space-y-2">
        <button id="settings-button" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition text-sm">‚öôÔ∏è Settings</button>
        <button id="backup-button" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition text-sm">üíæ Create Backup</button>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col overflow-hidden">
      
      <!-- Welcome Screen -->
      <div id="welcome-screen" class="flex-1 flex items-center justify-center p-8">
        <div class="text-center max-w-md">
          <div class="text-6xl mb-4">üí¨</div>
          <h2 class="text-2xl font-bold text-white mb-2">Welcome!</h2>
          <p class="text-gray-400">Select a chat or start a new one.</p>
        </div>
      </div>

      <!-- Chat Window -->
      <div id="chat-window" class="hidden flex-1 flex flex-col overflow-hidden">
        
        <!-- Chat Header -->
        <header class="p-4 border-b border-gray-700 bg-gray-800 flex items-center justify-between">
          <div class="flex-1">
            <h2 id="chat-header-name" class="font-semibold text-white text-lg">Chat</h2>
            <p id="typing-indicator" class="text-xs text-blue-400 h-4"></p>
          </div>
          <button id="chat-info-button" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm transition">‚ÑπÔ∏è Info</button>
        </header>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4 bg-gray-900" id="message-list-container">
          <button id="load-older" class="hidden w-full px-4 py-2 mb-4 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded transition text-sm">Load older messages</button>
          <div id="message-list" class="space-y-3"></div>
        </div>

        <!-- Input Area -->
        <footer class="p-4 bg-gray-800 border-t border-gray-700">
          <div class="flex items-end space-x-2">
            <button id="attach-button" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition flex-shrink-0" aria-label="Attach file">üìé</button>
            <textarea id="message-input" rows="1" placeholder="Type a message..." class="flex-1 bg-gray-900 border border-gray-700 rounded px-4 py-2 text-gray-200 outline-none focus:ring-2 focus:ring-blue-500 resize-none max-h-32" aria-label="Message"></textarea>
            <button id="send-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition flex-shrink-0">Send</button>
          </div>
          <input id="image-upload" type="file" accept="image/*" class="hidden" aria-label="Upload image">
        </footer>
      </div>
    </main>
  </div>

<!-- Settings Modal Content (will be injected) -->
<template id="settings-template">
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <label class="text-gray-300 text-sm">Send read receipts</label>
      <input type="checkbox" id="setting-read-receipts" class="w-4 h-4 rounded border-gray-600 bg-gray-700 focus:ring-2 focus:ring-blue-500" checked>
    </div>
    <div class="flex items-center justify-between">
      <label class="text-gray-300 text-sm">Show typing indicators</label>
      <input type="checkbox" id="setting-typing-indicators" class="w-4 h-4 rounded border-gray-600 bg-gray-700 focus:ring-2 focus:ring-blue-500" checked>
    </div>
    <hr class="border-gray-700">
    <button id="link-account-button" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition text-sm">Link Email</button>
    <!-- Language Switcher -->
    <button id="language-button" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition text-sm flex items-center justify-center">
      <span id="language-icon">üåê</span>
      <span id="language-text" class="ml-2">English</span>
    </button>
    <button id="restore-button" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition text-sm">Restore Backup</button>
  </div>
</template>

  <!-- Chat Info Modal Content -->
  <template id="chat-info-template">
    <div class="space-y-4 text-sm">
      <div>
        <h3 class="font-semibold text-white mb-2">Security</h3>
        <div class="bg-gray-900 rounded p-3 space-y-2">
          <div>
            <p class="text-gray-400 text-xs">Your fingerprint:</p>
            <p id="fingerprint-self" class="font-mono text-xs text-green-400 break-all">‚Äî</p>
            <button id="copy-fpr-self" class="mt-1 text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded">Copy</button>
          </div>
          <div>
            <p class="text-gray-400 text-xs">Partner fingerprint:</p>
            <p id="fingerprint-partner" class="font-mono text-xs text-blue-400 break-all">‚Äî</p>
            <button id="copy-fpr-partner" class="mt-1 text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded">Copy</button>
          </div>
          <button id="verify-fpr-btn" class="w-full mt-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition text-xs">Compare fingerprints</button>
        </div>
      </div>
      <p class="text-xs text-gray-500">Compare these fingerprints over a secure channel (e.g., in person) to ensure no one is intercepting the communication.</p>
    </div>
  </template>

  <script type="module" src="./app.js"></script>
</body>
</html>